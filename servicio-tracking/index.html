<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracking Profesional (Parcial)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* 3. El mapa DEBE tener una altura definida */
    #mapaCliente {
      height: 500px;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="row g-4">

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-success-emphasis">PANEL DEL REPARTIDOR</h5>
          <p class="card-text">Usa la geolocalización de tu navegador para enviar tu ubicación real.</p>
          <button id="btnStartTracking" class="btn btn-success w-100 mb-2">Iniciar Tracking</button>
          <button id="btnStopTracking" class="btn btn-danger w-100" disabled>Detener Tracking</button>
          <div id="statusRepartidor" class="alert alert-info mt-3" role="alert">
            Estado: Desconectado
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-primary-emphasis">MAPA DEL CLIENTE (En Vivo)</h5>
          <div id="mapaCliente" class="mt-2"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // --- Configuración Inicial ---
  const socket = io();
  const btnStart = document.getElementById('btnStartTracking');
  const btnStop = document.getElementById('btnStopTracking');
  const statusEl = document.getElementById('statusRepartidor');
  let watchId = null; // ID para detener el tracking

  // --- Lógica del Mapa (Cliente) ---
  const latInicial = -12.046374; // Centro de Lima
  const lngInicial = -77.042793;
  
  const map = L.map('mapaCliente').setView([latInicial, lngInicial], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const marker = L.marker([latInicial, lngInicial]).addTo(map);
  marker.bindPopup("Repartidor").openPopup();

  // Escuchar actualizaciones del servidor
  socket.on('tracking_actualizado', function(coords) {
    console.log('Cliente: Recibiendo (Lat/Lng)...', coords);
    const nuevaPosicion = [coords.lat, coords.lng];
    
    // Mover el marcador y centrar el mapa
    marker.setLatLng(nuevaPosicion);
    map.panTo(nuevaPosicion);
    
    // Actualizar popup
    marker.setPopupContent(`Repartidor en: ${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`).openPopup();
  });


  // --- Lógica del Repartidor (Geolocalización) ---
  
  // 1. Al hacer clic en "Iniciar"
  btnStart.addEventListener('click', () => {
    if (!navigator.geolocation) {
      statusEl.className = 'alert alert-danger';
      statusEl.textContent = 'Error: Tu navegador no soporta geolocalización.';
      return;
    }

    // Opciones para alta precisión (modo repartidor)
    const options = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    };

    // watchPosition() se activa CADA VEZ que el GPS detecta movimiento
    watchId = navigator.geolocation.watchPosition(onSuccess, onError, options);
    
    // Actualizar UI
    btnStart.disabled = true;
    btnStop.disabled = false;
    statusEl.className = 'alert alert-warning';
    statusEl.textContent = 'Buscando señal GPS...';
  });

  // 2. Al hacer clic en "Detener"
  btnStop.addEventListener('click', () => {
    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    
    // Actualizar UI
    btnStart.disabled = false;
    btnStop.disabled = true;
    statusEl.className = 'alert alert-info';
    statusEl.textContent = 'Estado: Desconectado';
  });

  // 3. Callback: Se obtuvo ubicación
  function onSuccess(position) {
    const { latitude, longitude } = position.coords;
    const coords = { lat: latitude, lng: longitude };

    console.log('Repartidor: Enviando ubicación REAL...', coords);
    
    // ¡Aquí está la magia! Emitimos la ubicación real al servidor
    socket.emit('repartidor_actualiza_ubicacion', coords); //

    statusEl.className = 'alert alert-success';
    statusEl.textContent = `Estado: Transmitiendo... (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;
  }

  // 4. Callback: Hubo un error
  function onError(error) {
    let errorMsg = 'Error desconocido';
    switch(error.code) {
      case error.PERMISSION_DENIED:
        errorMsg = 'Error: No diste permiso de ubicación.';
        break;
      case error.POSITION_UNAVAILABLE:
        errorMsg = 'Error: Información de ubicación no disponible.';
        break;
      case error.TIMEOUT:
        errorMsg = 'Error: Se agotó el tiempo de espera.';
        break;
    }
    statusEl.className = 'alert alert-danger';
    statusEl.textContent = errorMsg;
    if (watchId) navigator.geolocation.clearWatch(watchId);
    btnStart.disabled = false;
    btnStop.disabled = true;
  }

</script>

</body>
</html>